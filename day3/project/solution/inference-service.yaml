# ============================================================
# Day 3 í”„ë¡œì íŠ¸ - KServe InferenceService ë°°í¬ YAML
# California Housing ì˜ˆì¸¡ ëª¨ë¸ ë°°í¬
#
# ì‚¬ìš©ë²•:
#   1. ë³€ìˆ˜ ì¹˜í™˜: TEAM_NAME, USER_NAMESPACE, S3_BUCKET, RUN_ID
#   2. kubectl apply -f inference-service.yaml
#
# í˜„ëŒ€ì˜¤í† ì—ë²„ MLOps êµìœ¡
# ============================================================

---
apiVersion: serving.kserve.io/v1beta1
kind: InferenceService
metadata:
  name: ${TEAM_NAME}-housing-predictor    # ì˜ˆ: team-01-housing-predictor
  namespace: ${USER_NAMESPACE}             # ì˜ˆ: kubeflow-user01
  labels:
    team: ${TEAM_NAME}
    project: california-housing
    version: v1
    environment: production
  annotations:
    # Istio ì‚¬ì´ë“œì¹´ ìë™ ì£¼ì…
    sidecar.istio.io/inject: "true"
    # ìµœì†Œ ë ˆí”Œë¦¬ì¹´ ìœ ì§€
    autoscaling.knative.dev/minScale: "1"
    # ìµœëŒ€ ë ˆí”Œë¦¬ì¹´ ì œí•œ
    autoscaling.knative.dev/maxScale: "3"
spec:
  predictor:
    # sklearn ëŸ°íƒ€ì„ ì‚¬ìš©
    sklearn:
      # S3 ëª¨ë¸ ê²½ë¡œ (ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜ í•„ìš”)
      storageUri: "s3://${S3_BUCKET}/models/${TEAM_NAME}/${RUN_ID}/"
      
      # ë¦¬ì†ŒìŠ¤ ìš”ì²­ ë° ì œí•œ
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
      
      # ëŸ°íƒ€ì„ ë²„ì „ (ì„ íƒì‚¬í•­)
      # runtimeVersion: "1.3.0"

---
# ============================================================
# Canary ë°°í¬ ë²„ì „ (ì„ íƒì  ì‚¬ìš©)
# ìƒˆ ëª¨ë¸ ë²„ì „ì„ ì ì§„ì ìœ¼ë¡œ ë°°í¬í•  ë•Œ ì‚¬ìš©
# ============================================================

# apiVersion: serving.kserve.io/v1beta1
# kind: InferenceService
# metadata:
#   name: ${TEAM_NAME}-housing-predictor-canary
#   namespace: ${USER_NAMESPACE}
#   labels:
#     team: ${TEAM_NAME}
#     project: california-housing
#     version: v2
#     deployment-type: canary
# spec:
#   predictor:
#     # Canary íŠ¸ë˜í”½ ë¹„ìœ¨ (10%)
#     canaryTrafficPercent: 10
#     sklearn:
#       # ìƒˆ ëª¨ë¸ ë²„ì „ ê²½ë¡œ
#       storageUri: "s3://${S3_BUCKET}/models/${TEAM_NAME}/${NEW_RUN_ID}/"
#       resources:
#         requests:
#           cpu: "100m"
#           memory: "256Mi"
#         limits:
#           cpu: "500m"
#           memory: "512Mi"

---
# ============================================================
# í…ŒìŠ¤íŠ¸ìš© ì˜ˆì œ ë°ì´í„° ConfigMap
# ============================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: ${TEAM_NAME}-test-data
  namespace: ${USER_NAMESPACE}
  labels:
    team: ${TEAM_NAME}
    purpose: testing
data:
  # ë‹¨ì¼ ì˜ˆì¸¡ ìš”ì²­ ì˜ˆì‹œ
  single_request.json: |
    {
      "instances": [
        [8.3252, 41.0, 6.984, 1.0238, 322.0, 2.555, 37.88, -122.23, 17.87, 0.146, 126.0, 3, 0]
      ]
    }
  
  # ë°°ì¹˜ ì˜ˆì¸¡ ìš”ì²­ ì˜ˆì‹œ (3ê°œ ìƒ˜í”Œ)
  batch_request.json: |
    {
      "instances": [
        [8.3252, 41.0, 6.984, 1.0238, 322.0, 2.555, 37.88, -122.23, 17.87, 0.146, 126.0, 3, 0],
        [5.6431, 52.0, 5.817, 1.0731, 558.0, 2.547, 37.85, -122.25, 14.78, 0.173, 219.0, 3, 0],
        [3.8462, 35.0, 5.136, 1.0017, 624.0, 2.418, 37.75, -122.41, 10.21, 0.154, 258.0, 2, 0]
      ]
    }
  
  # í”¼ì²˜ ì„¤ëª…
  feature_description.txt: |
    California Housing í”¼ì²˜ ìˆœì„œ (13ê°œ):
    
    ì›ë³¸ í”¼ì²˜ (8ê°œ):
    1.  MedInc           - ì¤‘ìœ„ ì†Œë“ (10,000ë‹¬ëŸ¬ ë‹¨ìœ„)
    2.  HouseAge         - ì£¼íƒ ì—°ì‹ (ë…„)
    3.  AveRooms         - í‰ê·  ë°© ê°œìˆ˜
    4.  AveBedrms        - í‰ê·  ì¹¨ì‹¤ ê°œìˆ˜
    5.  Population       - ë¸”ë¡ ê·¸ë£¹ ì¸êµ¬
    6.  AveOccup         - í‰ê·  ê±°ì£¼ì ìˆ˜
    7.  Latitude         - ìœ„ë„
    8.  Longitude        - ê²½ë„
    
    íŒŒìƒ í”¼ì²˜ (5ê°œ):
    9.  rooms_per_household       - ê°€êµ¬ë‹¹ ì´ ë°© ìˆ˜
    10. bedrooms_per_room         - ë°©ë‹¹ ì¹¨ì‹¤ ë¹„ìœ¨
    11. population_per_household  - ê°€êµ¬ë‹¹ ì¸êµ¬
    12. income_category           - ì†Œë“ êµ¬ê°„ (1-5)
    13. location_cluster          - ìœ„ì¹˜ í´ëŸ¬ìŠ¤í„° (0=SF, 1=LA)
    
    íƒ€ê²Ÿ (ì˜ˆì¸¡ê°’):
    - MedHouseVal: ì¤‘ìœ„ ì£¼íƒ ê°€ê²© (100,000ë‹¬ëŸ¬ ë‹¨ìœ„)

---
# ============================================================
# ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ Job (ì„ íƒì  ì‚¬ìš©)
# ============================================================

apiVersion: batch/v1
kind: Job
metadata:
  name: ${TEAM_NAME}-api-test
  namespace: ${USER_NAMESPACE}
  labels:
    team: ${TEAM_NAME}
    purpose: testing
spec:
  ttlSecondsAfterFinished: 300  # ì™„ë£Œ í›„ 5ë¶„ ë’¤ ìë™ ì‚­ì œ
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: api-tester
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "=============================================="
          echo "KServe API í…ŒìŠ¤íŠ¸ ì‹œì‘"
          echo "=============================================="
          
          SERVICE_URL="http://${TEAM_NAME}-housing-predictor.${USER_NAMESPACE}.svc.cluster.local/v1/models/${TEAM_NAME}-housing-predictor:predict"
          
          echo ""
          echo "ğŸ“ ì„œë¹„ìŠ¤ URL: $SERVICE_URL"
          echo ""
          
          # ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
          echo "â³ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          sleep 10
          
          # ë‹¨ì¼ ì˜ˆì¸¡ í…ŒìŠ¤íŠ¸
          echo ""
          echo "ğŸ§ª ë‹¨ì¼ ì˜ˆì¸¡ í…ŒìŠ¤íŠ¸:"
          echo "----------------------------------------------"
          curl -s -X POST $SERVICE_URL \
            -H "Content-Type: application/json" \
            -d '{"instances": [[8.3252, 41.0, 6.984, 1.0238, 322.0, 2.555, 37.88, -122.23, 17.87, 0.146, 126.0, 3, 0]]}'
          
          echo ""
          echo ""
          
          # ë°°ì¹˜ ì˜ˆì¸¡ í…ŒìŠ¤íŠ¸
          echo "ğŸ§ª ë°°ì¹˜ ì˜ˆì¸¡ í…ŒìŠ¤íŠ¸ (3ê°œ ìƒ˜í”Œ):"
          echo "----------------------------------------------"
          curl -s -X POST $SERVICE_URL \
            -H "Content-Type: application/json" \
            -d '{"instances": [[8.3252, 41.0, 6.984, 1.0238, 322.0, 2.555, 37.88, -122.23, 17.87, 0.146, 126.0, 3, 0], [5.6431, 52.0, 5.817, 1.0731, 558.0, 2.547, 37.85, -122.25, 14.78, 0.173, 219.0, 3, 0], [3.8462, 35.0, 5.136, 1.0017, 624.0, 2.418, 37.75, -122.41, 10.21, 0.154, 258.0, 2, 0]]}'
          
          echo ""
          echo ""
          echo "=============================================="
          echo "âœ… API í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
          echo "=============================================="
